---
id: service-manifest
title: مانیفست سرویس
sidebar_label: مانیفست سرویس
---
---
id: service-manifest
title: مانیفست سرویس
sidebar_label: مانیفست سرویس
---
## مانیفست سرویس چیست؟
دیپلوی کردن سرویس‌ها بسته به تنظیماتی که حین دیپلوی سرویس مشخص می‌کنید می‌تواند پیچیده شود، و انجام این کار با استفاده از `fandogh service deploy` برای تعداد زیادی سرویس ممکن است کاملا خسته‌کننده شود به علاوه اینکه احتمال خطا در تنظیمات را هم بالا می‌برد.
برای اینکه این امر را ساده‌تر کنیم و احتمال بروز خطا را کاهش دهیم، امکانی را در نظر گرفتیم که شما مشخصات سرویسی که قرار است ساخته شود را در یک فایل با فرمت و ساختار مشخص می‌نویسید و هر بار که فایل را از طریق `fandogh service apply` در اختیار CLI قرار دهید، سرویس مورد نظر شما با مشخصات مورد نظر شما ایجاد **یا با ویژگی‌های جدید به روزرسانی** می‌شود.

## ساختار مانیفست سرویس
اگر قبلا با CLI برای دیپلوی سرویستون کار کرده باشید احتمالا بیشتر قسمت‌های مانیفست به نظر شما آشنا میاد، در غیر اینصورت هم نگران نباشید، مانیفست بسیار ساختار ساده‌ای داره و هر چیزی که داخل مانیفست هست رو همینجا به تشریح توضیح خواهیم داد.
فرمت فایل‌های مانیفست Yaml هستش، درست مثل Json هستش فقط شمایل متفاوتی داره و به نسبت خواناتر هستش.
به ازای هر سرویس شما یک آبجکت باید بنویسید که فیلد‌های زیر رو دارد:

 - kind
 نوع سرویسی که قصد دیپلوی اون رو دارید، انواع سرویس این موارد هستند:
	 - **ExternalService** برای سرویس‌هایی که قصد دارید به طور خارجی در دسترس باشند، مثل API‌ها، این نوع سرویس‌ها حالت پیشفرض بدون حضور سویچ `internal--‍` در دستور `fandogh service deploy‍` است.
	 - **InternalService** برای سرویس‌هایی که داخلی هستند، و فقط  توسط سرویس‌های دیگر شما استفاده می‌شوند، مثل دیتابیس‌های، Message brokerها و...، این نوع سرویس‌ها مثل سویچ `internal--` در دستور `fandogh service deploy‍` است.
	 -  **ManagedService** برای سرویس‌های آماده استفاده فندق مثل mysql یا Postgresql
 - name
 نامی که برای سرویس خود انتخاب کردید، این نامی هستش که بقیه سرویس‌ها از طریق آن این سرویس را پیدا می‌کنند، این مورد مشابه سویچ `name--` در دستور `fandogh service deploy` است.
 - spec
این فیلد حاوی آبجکتی است که بسته به مقدار فیلد `kind` ساختار متفاوتی داره و مشخصات سرویس شما داخل اون قرار میگیره.
این ساختار کلی مانیفست هستش:
```
---
kind: ExternalService
name: some-api
spec: 

```
که البته در قسمت spec باید مشخصات سرویس قرار بگیره.
حالا مقدار فیلد `spec‍` رو به ازای `kind`های مختلف بررسی می‌کنیم:
### فیلد spec در ExternalService ها
کلید‌های اصلی برای این فیلد عبارتند از:
 - image
این فیلد باید حاوی نام و ورژن ایمیجی باشد که مایلید سرویس از روی آن ساخته شود، به مثال‌های زیر توجه کنید:
	 - `my_api:7.9.1` یعنی ورژن 7.9.1 از ایمیج my_api  که [قبلا در فندق منتشر](https://docs.fandogh.cloud/docs/images.html) کردید
	 - `library/nginx:latest` یعنی ورژن latest  از ایمیج nginx که در رجسیتری docker hub قرار دارد.
	 -‍ `docker-registry.my-company.com:5000/my-api:2.3` یعنی ورژن 2.3 از ایمیجی که در یک رجیستری دلخواه قبلا push کرده‌اید.

> توجه داشته باشید اگر این رجیستری private است و نیاز به credential دارد
> [باید secret مورد نیاز را
> بسازید](https://docs.fandogh.cloud/docs/secret.html#docker-registry) و
> حتما فیلد `image_pull_secret` را در مانیفست مشخص کنید.

 - image_pull_policy
زمانی که از رجیستری‌های خارجی استفاده می‌کنید بسته به اینکه چطور ورژن‌های مربوط به تصاویر خود را مدیریت می‌کنید ممکن است نیاز پیدا کنید همیشه صرف‌نظر از اینکه image روی registry محلی فندق هست یا نیست حتما ایمیج از رجیستری دوباره دریافت شود، برای این کار باید این فیلد را روی مقدار `Always‍` ست کنید، حالت پیشفرض این فیلد `IfNotPresent`  است.
 - image_pull_secret
 زمانی که قرار است ایمیج مربوط به سرویس از یک رجیستری خارجی private دریافت شود(pull شود) لازم است [قبلا Secret مربوط به رجیستری را ساخته باشید](https://docs.fandogh.cloud/docs/secret.html#docker-registry) و نام secret را اینجا مشخص کنید.
 - replicas
در این فیلد می‌تونید مشخص کنید که چند instance از سرویستون نیاز دارید، به طور پیشفرض مقدار این فیلد 1 هستش.
 - port
از طریق این فیلد مشخص می‌کنید که سرویس شما روی کدوم پورت داره سرویس میده، مثلا اگر یک اپ NodeJS دارید که روی پورت ۳۰۰۰ اجرا شده و می‌خواید درخواست‌های HTTP از پورت 80 به پورت3000 اون سرویس برسه اینجا باید مشخصش کنید.
البته به طور پیش‌فرض پورت ۸۰ همیشه در نظر گرفته میشه و اگر سرویستون روی پورت ۸۰ سرویس میده نیاز ندارید این فیلد رو مشخص کنید.
 - path
 اگر مایل هستید سرویستون روی path خاصی درخواست‌ها رو پاسخ بده، مثلا یک سرویس wordpress دارید به عنوان بلاگ استفاده می‌کنید، می‌تونید از طریق این فیلد path رو مشخص کنید، مثلا `/blog/`  تا فقط درخواست‌هایی که به اون مسیر ارسال شدند به وردپرستون برسند و روی بقیه path ها  بتونید سرویس‌های دیگه اجرا کنید.
 - allow_http
اگر این فیلد true باشه، معنیش این هستش که فندق نباید درخواست‌های HTTP رو به HTTPS ریدایرکت کنه. به طور پیشفرض مقدار این فیلد true هستش تا درخواست HTTP ریدایرکت نشند.
 - env
این فیلد یک آرایه از environment variable‌هایی هستش که مایلید موقع اجرای پراسس توی کانتینرتون ست شده باشند، می‌تونید به این شکل مقادیرش رو مشخص کنید:
```
  env:
    - name: some_variable
      value: some_value

```
 - domains
اینجا می‌تونید لیست دامنه‌هایی که می‌خواید به این سرویس متصل کنید رو مشخص کنید، مثلا سرویس مورد نظر فرانت وب‌سایتتون هستش و مایلید روی domain.com و www.domain.com  در دسترس باشه:
```
  domains:
     - name: domain.com
     - name: www.domain.com
```
 - port_mapping
بعضی وقت‌ها یک سرویس بخصوص ممکنه نیاز داشته باشه بیش از یک پورت از خودش رو expose کنه، البته منظور Expose کردن برای سرویس‌های داخل همون Namespace هستش، برای اینکار می‌تونید از این فیلد استفاده کنید، مثلا میخوایم پورت ۸۰۸۰ کانتینر رو روی پورت ۸۰۸۱ با پروتکل TCP  اکسپوز کنیم و پورت 11001رو روی پورت دیگه‌ای مثل 7701 با پروتکل UDP اکسپوز کنیم:
```
  port_mapping:
    - port: 8081
      target_port: 8080
      protocol: TCP
    - port: 7701
      target_port: 11001
      protocol: UDP
```
> توجه داشته باشید که target_port پورتی هستش که داخل کانتینر سرویس شما
> روی اون پورت داره سرویس میده و port پورتی هستش که قرار هست بقیه
> سرویس‌ها از بیرون از طریق اون پورت با اون سرویس بخصوص تماس بگیرند

مقدار پیشفرض برای پروتکل TCP هستش، پس نیازی نیست همیشه قید کنید اگر به UDP نیازی ندارید.

 - resources
از طریق این فیلد می‌تونید مشخص کنید که چه مقدار منابع نیاز دارید، ساختار این فیلد به این شکل است:
```
  resources:
    memory: 200Mi
```
که 200Mi یعنی ۲۰۰ مگابایت فضای رم باید به این سرویس تخصیص داده بشه، می‌تونید هر مقداری که نیاز دارید رو مشخص کنید،‌مثلا برای ۱ گیگ باید 1024Mi بنویسید.

## فیلد‌ spec در InternalServiceها
فیلد spec در InternalService ها کاملا مشابه فیلد spec در ExternalService ها هستش به جز اینکه فیلد‌های زیر رو نداره:
- port
- path
- allow_http
- domains

## فیلد spec در ManagedServiceها
 - service_name
از طریق این فیلد مشخص می‌کنید کدام یک از managed-service های فندق را قصد دارید ایجاد کنید، برای مشاهده انواع managed-service‌ها به [این بخش](https://docs.fandogh.cloud/docs/managed-services.html#%D8%A7%D9%86%D9%88%D8%A7%D8%B9-managed-service) رجوع کنید.
 - version
از طریق این فیلد مشخص می‌کنید برای سرویس انتخاب شده کدام ورژن را مایل هستید دیپلوی کنید.
 - parameters
هر managed-service مجموعه‌ای پارامتر‌های پیکربندی را دارد که می‌توانید از طریق این قسمت مشخص کنید مثلا برای یک سرویس mysql می‌توانیم این موارد را مشخص کنیم:
```
  parameters:
    - name: phpmyadmin_enabled
      value: true
    - name: mysql_root_password
      value: root
```

 - resources
از طریق این فیلد می‌تونید مشخص کنید که چه مقدار منابع نیاز دارید، ساختار این فیلد به این شکل است:
```
  resources:
    memory: 200Mi
```
که 200Mi یعنی ۲۰۰ مگابایت فضای رم باید به این سرویس تخصیص داده بشه، می‌تونید هر مقداری که نیاز دارید رو مشخص کنید،‌مثلا برای ۱ گیگ باید 1024Mi بنویسید.
