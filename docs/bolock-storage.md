# ‌Block Storage

هر سرویس دارای اطلاعات ارزشمندی می باشد که باید بتواند آن ها را در فضایی پایا ذخیره کند تا بتواند در هر زمان به آن دسترسی داشته باشد. کپسول ها در بستر فندق٬ این محل های ذخیره سازی **volume** نام دارند و مدیریت تمام این **volume ها** در فضایی به نام **Block Storage** در سکوی فندق انجام می شود.

## انواع volume ها

فندق برای آنکه سرویس ها بتوانند اطلاعات خود را در فضایی پایا و مانا ذخیره کنند دو ویژگی در نظر گرفته است:

**۱- فضای ذخیره سازی اشتراکی  
۲- فضای ذخیره سازی اختصاصی (Block Storage)**

  

#### ۱- فضای ذخیره سازی اشتراکی :

همانطور که از اسم این فضا مشخص است٬ سکوی فندق برای هر کاربر یک فضای ذخیره سازی اختصاصی را فراهم می کند.

با اینکه این فضا مشکل ذخیره سازی اطلاعات را حل می کند اما مشکلاتی را هم به همراه دارد. این فضا از فضای ذخیره سازی خود فندق بوده و سرعت خواندن و نوشتن بر روی آن کندتر از یک هارد اختصاصی است.

بگذارید کمی شفاف تر بیان کنیم٬ فضای ذخیره سازی اشتراکی همانند هارد دیسک می باشد و هر کاربر یک پوشه اختصاصی در آن دارد که کاملا امن بوده و هیچ کس به پوشه کس دیگری نمی تواند ورود کند.

اما با اینکه امنیت این موضوع کاملا از سمت فندق تضمین می شود اما مشکل اصلی این است که همه کاربران درخواست های خود را٬ چه برای خواندن یک فایل و چه برای نوشتن یک فایل٬ به همین هارد میفرستند و این موضوع باعث کندتر شدن عملکرد سرویس هایی می شود که سرعت خواندن و نوشتن اطلاعات برایشان بسیار حائز اهمیت است.

حال راه حل کجاست؟

فندق برای عبور از این مشکل Block Storage و Volume ها را در قالب یک ویژگی در سکو خود ارائه کرده است.

#### ۲- فضای ذخیره سازی اختصاصی (Block Storage) :

در بالا مشکلات استفاده از فضای ذخیره سازی اشتراکی را بیان کردیم و گفتیم Block Storage یک راه حل از سکو فندق برای رفع این مشکل است.

برای آنکه بتوان از افت سرعت و کیفیت سرویس ها جلوگیری کرد فندق Block Storage را به سکو خود اضافه کرده است تا با استفاده از آن هر سرویس بتواند یک هارد اختصاصی یا همان volume برای ذخیره سازی اطلاعات خود داشته باشد.

تمام volume هایی که کاربران میسازند٬ همگی در Block Storage فندق قرار دارند و در همان جا مدیریت می شوند تا شما نگران مدیریت و نگهداری آن ها نباشید و همینطور در طراحی و پیاده سازی تیم فندق تمام تلاش خود را کرده است تا رویه ساخت و استفاده از volume ها تا حد امکان برای کاربرها ساده و به دور از هر گونه سختی باشد.


## چگونگی ساخت volume

volume ها هم٬ مانند تمام موارد دیگری که در فندق ساخته می شوند نیازمند یک درخواست هستند.
برای این امر٬ مثل دستور زیر کاربر می تواند با استفاده از دستور add درخواستی مبنی بر ساخت یک volume به سرور فندق بفرستد.

```
Fandogh volume add --name vol1 -c 5Gi
Fandogh volume add --name vol2 -c 2Gi
Fandogh volume add --name vol3 -c 20Gi
```

**پارامترهای دستور add :**

**n- یا name-- :  **
با استفاده از این پارامتر کاربر نام دلخواهی برای volume خود انتخاب می کند.

  

**c- یا --capacity :  **
با استفاده از این پارامتر کاربر می تواند مقدار فضای مورد نیاز خود را وارد کند.


> **توجه داشته باشید در انتهای مقدار فضای انتخابی خود٬ حتما از کلید واژه Gi استفاده کنید٬ در غیر این صورت سرور٬ درخواست ساخت  volume را قبول نخواهد کرد.**

بعد از آنکه درخواستی مبنی بر ساخت یک volume به سمت سرور بیاید٬ فندق این درخواست ها را بررسی کرده و سریعا به Block Storage خود منتقل می کند تا رویه ساخت volume انجام شود که در 
شکل زیر نمایی مفهومی از این رویه را مشاهده میکنید.

![Volume Creation](/img/docs/volume_creation.png "Volume Creation")

بعد از آنکه درخواست ساخت volume با موفقیت به پایان برسد٬ سرور پاسخی را در قالب جدول زیر برای شما ارسال خواهد کرد.

| Name | Status | Mounted To | Volume 			  | Capacity | Creation Date |
|------|--------|------------|--------------------|------------|-----|
|vol1  |Bound   |    None    |pvc-28a98eabebfd11e8|5Gi| 2018-11-19 13:15:17+00:00

همانطور که در جدول بالا مشاهده می کنید٬ یک پیغام مبنی بر موفقیت آمیز بودن ساخت volume با نام vol1 نمایش داده شده و در ادامه آن یک جدول نمایش داده شده است که دارای چند ستون می باشد که در در آن اطلاعاتی مربوط به volume تازه ساخته شده آورده شده که در ادامه در مورد هر کدام از این فیلدها توضیح خواهیم داد.

**توضیح ستون ها :**

-   Name :  
    این ستون بیانگر نام volume می باشد که شما در دستور خود به سرور فرستاده اید.
    
-   Status :  
    این ستون بیانگر این موضوع است که volume ساخته شده به درستی به Block Storage متصل شده است یا خیر. مقادیر نمایش داده شده در این ستون دو حالت دارد:
    

Bound : یعنی volume در به درستی ساخته و تنظیم شده است و آماده اتصال به یک سرویس میشود.

Unbound : یعنی ‌Block Storage هنوز در حال آماده سازی volume می باشد و باید کمی صبر کنید تا کار Block Storage تمام شده و وضعیت به Bound تغییر کند تا بتوانید volume را به سرویس مورد نظر خود متصل کنید.

  

توجه : برای اطلاع از وضعیت volume های خود می توانید از دستور زیر استفاده کنید.

Fandogh volume list

این دستور جدولی شامل لیست تمام volume های شما را نمایش خواهد داد.

-   Mounted To :  
    این ستون به ما میگوید که آیا در حال حاضر به سرویسی متصل شده است یا خیر. در صورتی volume به سرویسی متصل باشد٬ نام آن سرویس در این ستون نمایش داده خواهد شد.
    
-   Volume :  
    این ستون نام کوبرنتیزی volume شما را نمایش میدهد.
    
-   Capacity :  
    این ستون حجم volume شما را نمایش میدهد.
    

Creation Date :  
همانطور که از نام این ستون مشخص است٬ تاریخ ساخته شدن یک volume در این ستون نمایش داده می شود.

## چگونگی اتصال سرویس به volume


![Volume Attachment](/img/docs/volume_attachment.png "Volume Attachment")

بعد از آنکه شما یک volume را ایجاد کردید٬ با استفاده از مانیفست می توانید سرویس خود را به volume دلخواهتان متصل کنید.

تنها کاری که باید انجام دهید این است که مانیفست سرویس فعلی را باز کرده و mount_path ای که میخواهید به volume متصل شود را نوشته و volume_name را که همان نام volume ساخته شده می باشد را هم مانند مانیفست زیر٬ به آن اضافه کنید.

```
volume_mounts:
- mount_path: /data
  volume_name: vol1
```

```
kind: InternalService  
name: cache  
  spec:  
    image: library/redis:latest  
    image_pull_policy: IfNotPresent  
    replicas: 1  
    env:  
     - name: VERSION  
       value: v1  
    port_mapping:  
     - port: 6379  
       target_port: 6379  
       # default protocol is TCP  
    resources:  
      memory: 400Mi
    volume_mounts:  
     - mount_path: /var/lib/mysql  
      sub_path: mysql 
     - mount_path: /data
      volume_name: vol1  
    liveness_probe:  
      initial_delay_seconds: 12  
      period_seconds: 60  
      http_get:  
        path: "/are-you-live"  
        port: 80  
    readiness_probe:  
      initial_delay_seconds: 5  
      period_seconds: 10  
      http_get:  
        path: "/are-you-ready"  
        port: 80
```

حال با استفاده از دستور service apply می توانید سرویس خود را اجاره کرده و در آخر ببینید که سرویس شما به درستی به volume متصل شده و اطلاعات مورد نیاز از مسیر data/ را در volume با نام vol1 ذخیره سازی می کند.

> توجه داشته باشید مانند تکه کد زیر٬ شما می توانید sub_path را هم به volume خود اضافه کنید تا از شلوغ شدن فضای ذخیره سازی جلوگیری به عمل آورید.
```
volume_mounts:
 - mount_path: /data
   sub_path: /data_sub
   volume_name: vol1
```

## چگونگی حذف یک volume

برای آنکه بتوانید یک volume را حذف کنید٬ کافی است تا نام volume مورد نظر را به دستور زیر بدهید.

```
Fandogh volume delete --name vol1
```

> توجه داشته باشید٬ اگر volume ای که قصد پاک کردن آن را دارید به یک سرویس متصل باشد٬ ابتدا باید آن سرویس را destroy کرده و بعد تلاش به حذف volume مورد نظر کنید.
